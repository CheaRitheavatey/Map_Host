<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Angkor Borei Map</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: sans-serif;
        }

        #map {
            height: 100vh;
            width: 100vw;
        }

        .custom-button {
            position: absolute;
            z-index: 9999;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
        }

        .custom-button button {
            background-color: #956134;
            color: #fbe8b4;
            border: none;
            border-radius: 20px;
            font-size: 26px;
            font-family: Georgia, serif;
            box-shadow: inset 0 1px 3px rgba(255, 255, 255, 0.3), 2px 2px 4px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            border: 3px solid #fbe8b4;
            width: 200px;
            height: 55px;
        }

        .custom-button button:hover {
            background-color: #8B4513;
        }

        /* New styles for attraction popup */
        .attraction-popup-overlay {
            position: fixed;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            transition: bottom 0.4s ease-out;
            bottom: -100%;
        }

        .attraction-popup-overlay.active {
            bottom: 0;
        }

        .attraction-popup-content {
            background: white;
            padding: 30px;
            border-radius: 20px 20px 0 0;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        .attraction-close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 24px;
            background: none;
            border: none;
            cursor: pointer;
            color: #666;
        }

        .attraction-popup-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .location-status {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            z-index: 1000;
            color: #333;
        }

        .location-status.active {
            color: #28a745;
        }

        .location-status.error {
            color: #dc3545;
        }
    </style>
</head>

<body>
    <div id="map"></div>
    <div class="location-status" id="locationStatus">üìç Locating...</div>
    <div id="mapButton" class="custom-button">
        <button>Video Demo</button>
    </div>

    <!-- New attraction popup structure -->
    <div class="attraction-popup-overlay" id="attractionPopup">
        <div class="attraction-popup-content">
            <button class="attraction-close-btn" onclick="closeAttractionPopup()">√ó</button>
            <img src="" class="attraction-popup-image" id="popupImage">
            <h2 id="popupTitle"></h2>
            <p id="popupDescription"></p>
        </div>
    </div>

    <script>
        // Image dimensions
        const mapWidth = 1080;
        const mapHeight = 1920;

        // Create a custom CRS that matches the image exactly
        const CustomCRS = L.extend({}, L.CRS.Simple, {
            infinite: false,
            transformation: new L.Transformation(1, 0, -1, mapHeight),
            bounds: L.bounds([0, 0], [mapWidth, mapHeight])
        });

        // Initialize the map
        const map = L.map('map', {
            crs: CustomCRS,
            minZoom: -1,
            maxZoom: 3,
            zoomControl: true,
            maxBounds: [[0, 0], [mapHeight, mapWidth]],
            maxBoundsViscosity: 1.0,
            attributionControl: false
        });

        // Image overlay
        const imageBounds = [[0, 0], [mapHeight, mapWidth]];
        L.imageOverlay('map1.png', imageBounds).addTo(map);
        map.fitBounds(imageBounds);

        // Add map click event to close popup
        map.on('click', function(e) {
            // Check if popup is open and close it
            const popup = document.getElementById('attractionPopup');
            if (popup.classList.contains('active')) {
                closeAttractionPopup();
            }
        });

        // Create an icon that maintains size during zoom
        const createStaticIcon = (iconUrl, size) => {
            return L.divIcon({
                html: `<img src="${iconUrl}" style="width: ${size[0]}px; height: ${size[1]}px;">`,
                className: 'static-marker-icon',
                iconSize: size,
                iconAnchor: [size[0] / 2, size[1]]
            });
        };

        // Attraction data with additional information for popups
        const attractions = [
            {
                name: "Restaurant",
                coords: [1200, 250],
                image: "restaurant.png",
                description: "Enjoy local Khmer cuisine with traditional flavors."
            },
            {
                name: "Angkor Borei Museum",
                coords: [1200, 500],
                image: "museum.png",
                description: "Discover ancient artifacts and learn about the region's history."
            },
            {
                name: "Angkor Borei Craft Community",
                coords: [1080, 250],
                image: "craft.png",
                description: "See local artisans creating traditional handicrafts."
            },
            {
                name: "Coffee Shop",
                coords: [950, 920],
                image: "coffee.png",
                description: "Relax with a cup of locally grown coffee."
            },
            {
                name: "Lobster",
                coords: [850, 650],
                image: "lobster.png",
                description: "Hand-on experience in feeding baby lobsters and learn the process of lobster farming."
            },
            {
                name: "CTC Center",
                coords: [580, 660],
                image: "ctc.png",
                description: "Community Tech Center with information about local attractions, located in Angkor Borei School."
            },
            {
                name: "Mountain",
                coords: [350, 900],
                image: "mountain.png",
                description: "Scenic viewpoint with panoramic views of the surrounding area."
            },
        ];

        // Function to open attraction popup
        function openAttractionPopup(attraction) {
            document.getElementById('popupTitle').textContent = attraction.name;
            document.getElementById('popupDescription').textContent = attraction.description;
            document.getElementById('popupImage').src = attraction.image;

            document.getElementById('attractionPopup').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        // Function to close attraction popup
        function closeAttractionPopup() {
            document.getElementById('attractionPopup').classList.remove('active');
            document.body.style.overflow = '';
        }

        // Close popup when clicking outside content
        document.getElementById('attractionPopup').addEventListener('click', function (e) {
            if (e.target === this) {
                closeAttractionPopup();
            }
        });

        // Add attractions to the map with click handlers
        attractions.forEach(place => {
            const marker = L.marker([place.coords[0], place.coords[1]], {
                icon: createStaticIcon('pin.png', [40, 40])
            }).addTo(map);
            
            // Prevent map click event when clicking on markers
            marker.on('click', function (e) {
                L.DomEvent.stopPropagation(e);
                openAttractionPopup(place);
            });
        });

        // Live user tracking marker
        let userMarker = null;
        let accuracyCircle = null;
        const locationStatus = document.getElementById('locationStatus');

        function updateLocation(pos) {
            // Use real GPS coordinates from the position object
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            const accuracy = pos.coords.accuracy;

            // Update location status
            locationStatus.textContent = `üìç Location: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            locationStatus.className = 'location-status active';

            // Convert to image coordinates
            const coords = latLngToImageXY(lat, lng);

            if (userMarker) {
                userMarker.setLatLng(coords);
                accuracyCircle.setLatLng(coords);
                accuracyCircle.setRadius(accuracy / 2); // Adjust radius based on GPS accuracy
            } else {
                userMarker = L.marker(coords, {
                    icon: createStaticIcon('here.png', [30, 30])
                }).addTo(map).bindPopup("You are here");

                accuracyCircle = L.circle(coords, {
                    radius: accuracy / 2,
                    color: 'lightblue',
                    fillColor: 'lightblue',
                    fillOpacity: 0.2
                }).addTo(map);
            }

            // Optional: Center map on user location (uncomment if desired)
            // map.setView(coords, map.getZoom());
        }

        function error(err) {
            console.warn("Location error:", err);
            locationStatus.textContent = `‚ùå Location unavailable: ${err.message}`;
            locationStatus.className = 'location-status error';
        }

        // Convert real GPS to image coordinates (adjusted for Phnom Penh area)
        function latLngToImageXY(lat, lng) {
           // X conversion (longitude to image X)
            const xScale = -41666.67; // pixels per degree longitude
            const xOffset = 4875000; // offset for longitude
            const x = (lng * xScale) + xOffset;
            
            // Y conversion (latitude to image Y) 
            const yScale = -69444.44; // pixels per degree latitude (negative because Y increases downward)
            const yOffset = -762500; // offset for latitude
            const y = (lat * yScale) + yOffset;
            
            return [y, x];
        }

        // Set up geolocation with enhanced options
        const geoOptions = {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 1000 // Cache position for 1 second
        };

        // Check if geolocation is supported
        if (navigator.geolocation) {
            locationStatus.textContent = 'üìç Requesting location...';
            navigator.geolocation.watchPosition(updateLocation, error, geoOptions);
        } else {
            locationStatus.textContent = '‚ùå Geolocation not supported';
            locationStatus.className = 'location-status error';
        }

        // Video demo button
        document.querySelector('#mapButton button').addEventListener('click', () => {
            window.open('https://www.canva.com/design/DAGtTkX7508/aszzDbtzHvr10J-7QVC-8g/watch');
        });
    </script>
</body>

</html>